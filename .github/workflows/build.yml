name: "Build"

on:
  push:
    branches:
      - "main"
  pull_request:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  check:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      # https://zenn.dev/mierune/articles/2af7b9e447712a
      - uses: chetan/git-restore-mtime-action@v2
      - uses: extractions/setup-just@v3
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: clippy,rustfmt
          cache-all-crates: true
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          cache: "pnpm"
          cache-dependency-path: ./renderer/pnpm-lock.yaml
      - uses: taiki-e/install-action@v2
        with:
          tool: dioxus-cli@0.7
      - run: just check
      - run: just fmt && git diff --exit-code
    timeout-minutes: 15

  test:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      # https://zenn.dev/mierune/articles/2af7b9e447712a
      - uses: chetan/git-restore-mtime-action@v2
      - uses: extractions/setup-just@v3
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          cache-all-crates: true
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          cache: "pnpm"
          cache-dependency-path: ./renderer/pnpm-lock.yaml
      - uses: taiki-e/install-action@v2
        with:
          tool: dioxus-cli@0.7
      # Retry up to 3 times due to flaky NSScreen API tests in headless environment
      - name: Run tests
        run: |
          for i in 1 2 3; do
            echo "Attempt $i/3"
            if just test; then
              exit 0
            fi
            if [ $i -lt 3 ]; then
              echo "Test failed, retrying in 5 seconds..."
              sleep 5
            fi
          done
          echo "All 3 attempts failed"
          exit 1
    timeout-minutes: 15

  build:
    needs: ["check", "test"]
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      # https://zenn.dev/mierune/articles/2af7b9e447712a
      - uses: chetan/git-restore-mtime-action@v2
      - uses: extractions/setup-just@v3
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          cache-all-crates: true
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          cache: "pnpm"
          cache-dependency-path: ./renderer/pnpm-lock.yaml
      - uses: taiki-e/install-action@v2
        with:
          tool: dioxus-cli@0.7
      - name: Apply version
        if: ${{ github.event_name == 'release' }}
        run: |
          sed -i '' "s/^version = \"0.0.0\"/version = \"${{ github.event.release.tag_name }}\"/" desktop/Cargo.toml
          sed -i '' "s/^version = \"v\(.*\)\"/version = \"\1\"/" desktop/Cargo.toml
      - run: just build
      - uses: actions/upload-artifact@v4
        with:
          name: arto-${{ runner.os }}
          path: |
            ./desktop/target/dx/arto/bundle/macos/bundle/dmg
          if-no-files-found: error
    timeout-minutes: 30

  build-nix:
    needs: ["check", "test"]
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v6
      - uses: nixbuild/nix-quick-install-action@v34
      - run: nix build
    timeout-minutes: 30

  release:
    if: ${{ github.event_name == 'release' }}
    needs: [build]
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: ./artifacts
      - run: find .
      - uses: ncipollo/release-action@v1.20.0
        with:
          allowUpdates: true
          artifactErrorsFailBuild: true
          artifacts: ./artifacts/arto-*/Arto_*.dmg
          removeArtifacts: true
          makeLatest: true
          body: |
            ## macOS Installation

            ### Installation Steps (2 Security Approvals Required)

            Due to Apple's security requirements, you'll need to approve **both the DMG file and the app itself**.

            #### Step 1: Open the DMG File

            1. **Download** the `Arto_*.dmg` file from the Assets section below
            2. **Double-click the DMG file**
               - Security warning appears: *"Apple cannot verify that this disk image does not contain malware"*
               - Click "OK" to dismiss
            3. **Open System Settings**
               - Apple menu () → System Settings → Privacy & Security
            4. **Allow the DMG** (in Security section at bottom)
               - You'll see: *"Arto_*.dmg" was blocked from use*
               - Click **"Open Anyway"** button
               - Enter your password
               - The DMG will now open

            #### Step 2: Install and Open the App

            5. **Copy the app**
               - Drag **Arto.app** from the DMG to your **Applications** folder
            6. **Double-click Arto.app** to launch
               - Security warning appears again: *"Arto cannot be opened because..."*
               - Click "OK" to dismiss
            7. **Allow the app** (same process as DMG)
               - Open System Settings → Privacy & Security
               - Scroll to Security section
               - Find: *"Arto" was blocked from use*
               - Click **"Open Anyway"**
               - Enter your password
            8. **Launch complete**
               - Arto will now start normally
               - Future launches won't require approval

            ### Why Two Approvals Are Needed

            macOS treats the DMG container and the app inside separately. Since both are unsigned,
            each requires manual approval through System Settings. This is standard macOS security
            for applications without Apple Developer ID certificates.

            ### Quick Method (Terminal - for advanced users)

            ```bash
            # Remove quarantine from DMG
            xattr -d com.apple.quarantine Arto_*.dmg
            open Arto_*.dmg

            # After copying to Applications, remove quarantine from app
            xattr -cr /Applications/Arto.app
            open /Applications/Arto.app
            ```

            ### Note for macOS Sequoia (15.0+) Users

            The right-click → "Open" shortcut no longer works for unsigned apps.
            You must use System Settings → Privacy & Security as described above.

            ---

            For more information, see the [README](https://github.com/${{ github.repository }}).

  dispatch:
    if: ${{ github.event_name == 'release' }}
    needs: [release]
    runs-on: ubuntu-latest
    steps:
      - name: Download release asset
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          VERSION_NO_V="${VERSION#v}"
          ASSET_NAME="Arto_${VERSION_NO_V}_aarch64.dmg"
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${VERSION}/${ASSET_NAME}"

          echo "Downloading ${ASSET_NAME} from ${DOWNLOAD_URL}"
          curl -L -o "${ASSET_NAME}" "${DOWNLOAD_URL}"

          # Calculate SHA256
          SHA256=$(sha256sum "${ASSET_NAME}" | cut -d' ' -f1)
          echo "SHA256: ${SHA256}"

          # Export for next step
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "SHA256=${SHA256}" >> $GITHUB_ENV
      - name: Dispatch to Homebrew tap
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.REPOSITORY_DISPATCH_TOKEN }}
          repository: arto-app/homebrew-tap
          event-type: update
          client-payload: '{"version": "${{ env.VERSION }}", "sha256": "${{ env.SHA256 }}"}'
